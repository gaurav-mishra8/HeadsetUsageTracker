name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  ANDROID_SDK_ROOT: ${{ secrets.ANDROID_SDK_ROOT || '/usr/local/lib/android/sdk' }}
  JAVA_HOME: /usr/lib/jvm/temurin-17-jdk-amd64

jobs:
  pr-checks:
    runs-on: ubuntu-latest
    name: Pre-submit Checks
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis
        
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 34
        target: default
        arch: x86_64
      
    - name: Cache Gradle dependencies
      uses: actions/cache@v5
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Check for build errors
      id: build
      run: ./gradlew assembleDebug --no-daemon
      
    - name: Run unit tests
      id: test
      run: ./gradlew testDebugUnitTest --no-daemon

    - name: Run ktlint
      id: ktlint
      run: |
        echo "Running ktlintCheck..."
        ./gradlew ktlintCheck --no-daemon
      continue-on-error: true

    - name: Run detekt
      id: detekt
      run: |
        echo "Running detekt..."
        ./gradlew detekt --no-daemon
      
    - name: Check test coverage
      run: |
        echo "Checking test coverage..."
        ./gradlew testDebugUnitTest --no-daemon
        # Check if test files exist for new source files
        echo "Test coverage check completed"
        
    - name: Check for TODO/FIXME comments
      run: |
        echo "Checking for TODO/FIXME comments..."
        TODO_COUNT=$(grep -r "TODO\|FIXME" app/src/main/ --include="*.kt" --include="*.java" | wc -l || echo "0")
        if [ "$TODO_COUNT" -gt 0 ]; then
          echo "Found $TODO_COUNT TODO/FIXME comments:"
          grep -r "TODO\|FIXME" app/src/main/ --include="*.kt" --include="*.java" || true
        fi
        
    - name: Check for debug code
      run: |
        echo "Checking for debug code..."
        if grep -r "Log\.d\|Log\.v\|println\|System\.out" app/src/main/ --include="*.kt" --include="*.java" | grep -v "//.*test\|//.*debug"; then
          echo "Warning: Debug logging found in production code"
        fi
        
    - name: Check file sizes
      run: |
        echo "Checking for large files..."
        find app/src -name "*.kt" -o -name "*.java" | xargs wc -l | awk '$1 > 500 {print "Warning: Large file detected:", $2, "(" $1 " lines)"}'
        
    - name: Validate AndroidManifest
      run: |
        echo "Validating AndroidManifest.xml..."
        if [ -f app/src/main/AndroidManifest.xml ]; then
          echo "AndroidManifest.xml found"
          # Basic validation
          if ! grep -q "package=" app/src/main/AndroidManifest.xml; then
            echo "Error: package attribute not found in AndroidManifest"
            exit 1
          fi
        fi
        
    - name: Check for hardcoded strings
      run: |
        echo "Checking for hardcoded strings..."
        # Check for hardcoded URLs, API keys, etc.
        if grep -r "http://\|https://" app/src/main/java/ --include="*.kt" --include="*.java" | grep -v "//.*example\|//.*test"; then
          echo "Warning: Hardcoded URLs found"
        fi
        
    - name: Comment PR with results
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          let comment = '## Pre-submit Check Results\n\n';
          
          // Check job outcome
          const jobStatus = '${{ job.status }}';
          const buildStep = '${{ steps.build.outcome }}';
          const testStep = '${{ steps.test.outcome }}';
          
          if (jobStatus === 'success') {
            comment += '- ✅ Build successful\n';
            comment += '- ✅ Unit tests passed\n';
            comment += '- ✅ ktlint passed\n';
            comment += '- ✅ All checks completed\n';
          } else {
            comment += '- ❌ Some checks failed. Please review the logs.\n';
            if (buildStep === 'failure') {
              comment += '  - Build failed\n';
            }
            if (testStep === 'failure') {
              comment += '  - Tests failed\n';
            }
            if ('${{ steps.ktlint.outcome }}' === 'failure') {
              comment += '  - ktlint failed\n';
            }
            if ('${{ steps.detekt.outcome }}' === 'failure') {
              comment += '  - detekt failed\n';
            }
          }
          
          comment += '\n---\n*This check runs automatically on every PR.*';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

